<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>iStage</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <!-- Icons / PWA basics -->
  <link rel="icon" type="image/svg+xml" href="/iStage/favicon.svg">
  <link rel="icon" sizes="192x192" href="/iStage/android-chrome-192x192.png">
  <link rel="icon" sizes="512x512" href="/iStage/android-chrome-512x512.png">
  <link rel="apple-touch-icon" href="/iStage/apple-touch-icon.png">
  <link rel="mask-icon" href="/iStage/pinned-tab.svg" color="#0f1116">

  <!-- Address bar color -->
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  <style>
  /* ---- Releases page (scoped) ---- */
  :root{
    --surface-light:#f5f5f7;
    --surface-dark:#0f1116; /* dark surface behind cards */
  }
  /* no backdrop under nav on this page */
  .page-releases .nav-backdrop{ display:none !important; }
  /* subtitle contrast */
  .page-releases .subtitle{ color:#5e6572; }
  @media (prefers-color-scheme: dark){
    .page-releases .subtitle{ color:#a7acb7; }
  }
  .page-releases{ background:#fff; }
  @media (prefers-color-scheme: dark){
    .page-releases{ background:#000; color:#e8e9ec; }
  }

  /* tighten heading stack + reserve space for hero image */
  .page-releases .copy{ gap:6px }
  .page-releases .title{ margin:0 0 4px }
  .releases-hero{ display:flex; justify-content:center; margin:8px 0 18px }
  .releases-hero img{
    width: clamp(180px, 48vw, 360px);
    height: auto;
    aspect-ratio: auto;
    object-fit: contain;
    background-color: transparent;
    box-shadow: none;
    filter: drop-shadow(0 8px 30px rgba(0,0,0,.12)); /* shadow follows alpha */
    border-radius: 12px;          /* optional rounding */
  }

  /* push first section clear of fixed nav (tiny extra to avoid clipping on iOS) */
  .page-releases .section--first{
    padding-top: calc(env(safe-area-inset-top) + var(--nav-offset-mobile) + 12px);
    margin-top:0;
  }
  @media (min-width:900px){
    .page-releases .section--first{
      padding-top: calc(env(safe-area-inset-top) + var(--nav-offset-desktop) + 14px);
    }
  }

  /* surface only for the list area (no grey behind the header) */
  .releases-surface{ background:transparent; padding:16px 0 24px; }

  /* card + typography balance */
  .releases-list{ display:grid; gap:16px; }
  .release-title{
    margin:0 0 1px;
    font-weight:600;
    font-size:clamp(18px, 4vw, 20px);
  }
  .release-meta{
    margin:-2px 0 0;
    display:flex;
    align-items:center;
    gap:.6ch;
  }
  .latest-badge{
    display:inline-flex;
    align-items:center;
    padding:2px 8px;
    border-radius:999px;
    border:1.5px solid #ff9f0a;
    color:#ff9f0a;
    font-weight:600;
    line-height:1;
    font-size:.85em;
  }
  @media (prefers-color-scheme: dark){
    .latest-badge{ border-color:#ff9f0a; color:#ff9f0a; }
  }
  .prose{ line-height:1.65; }
  .prose h1,.prose h2{ font-size:clamp(18px, 4vw, 20px); margin:16px 0 8px; font-weight:600; }
  .prose h3{ font-size:clamp(16px, 4vw, 18px); margin:16px 0 6px; }
  .prose p{ margin:8px 0; font-size:clamp(14px, 3.6vw, 16px); }
  .prose ul{ margin:8px 0 8px 1.2rem; padding:0; }
  .prose li{ margin:6px 0; }
  /* Slightly increase horizontal padding for body text */
  .prose{ padding-inline: 6px; }
  @media (min-width:900px){
    .prose{ padding-inline: 10px; }
  }
  .release-head{
    display:grid;
    grid-template-columns:auto 1fr;
    column-gap:12px;
    align-items:center;
    padding:2px 0 0 2px; /* nudge to equalize icon top/left margin */
  }
  .release-icon{
    width:clamp(40px, 12vw, 56px);
    height:clamp(40px, 12vw, 56px);
    flex:0 0 auto;
    border-radius:8px;
    object-fit:contain;
  }
  .release-head-text{
    min-width:0;
    display:flex;
    flex-direction:column;
    justify-content:center; /* vertically center next to the icon */
    padding-left:4px;       /* move texts slightly to the right */
  }
  .release-actions{ display:flex; align-items:center; gap:.6rem; }
  /* card surface follows theme; no outer surface */
  .page-releases .card{
    background:#f5f5f7;
    color:#111317;
    border:0;
    border-radius:18px;
  }
  @media (prefers-color-scheme: dark){
    .page-releases .card{
      background:#0f1116;
      color:#e8e9ec;
      border:0;
    }
  }
  .release-foot{
    display:flex; justify-content:flex-end; align-items:center; gap:.6rem; margin-top:12px;
  }

  /* footer theming only for releases page */
  .page-releases .footer{
    background:#f5f5f7;
    color:#5e6572;
  }
  @media (prefers-color-scheme: dark){
    .page-releases .footer{
      background:#0f1116;
      color:#a7acb7;
    }
  }

  .page-releases main{ margin-bottom:0; padding-bottom:0 }
  .page-releases .footer{ margin:0 }
  </style>
</head>
<body class="page-releases">
<nav class="nav" role="navigation" aria-label="Primary">
  <div class="nav-inner">
    <div class="container row">
      <a class="brand" href="../" aria-label="iStage">
        <img class="brand-logo" src="../assets/img/logo.png" alt="" loading="eager" decoding="async">
        <span class="brand-text">iStage</span>
      </a>
      <ul class="menu desktop">
        <li><a href="../iStage-26/">iStage 26</a></li>
        <li><a href="../iStage-18/">iStage 18</a></li>
        <li><a href="../compare/">Compare</a></li>
        <li><a href="../releases/">Releases</a></li>
        <li><a href="../help/">Help</a></li>
        <li><a href="../gallery/">Gallery</a></li>
      </ul>
      <button class="nav-toggle" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-sheet">
        <span class="nav-toggle-bar"></span>
      </button>
    </div>
    <div class="container sheet" id="mobile-sheet" aria-hidden="true">
      <div class="sheet-content">
        <ul class="mobile-menu">
          <li><a href="../iStage-26/">iStage 26</a></li>
          <li><a href="../iStage-18/">iStage 18</a></li>
          <li><a href="../compare/">Compare</a></li>
          <li><a href="../releases/">Releases</a></li>
          <li><a href="../help/">Help</a></li>
          <li><a href="../gallery/">Gallery</a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>
<main>
  <section class="section section--first" id="releases">
    <div class="container hero copy">
      <h1 class="title" style="margin-bottom:4px">Releases</h1>
      <p class="subtitle small">Latest changes and downloads.</p>
      <div class="releases-hero">
        <img src="../assets/img/releases-hero.png" alt="iStage lock screen preview" loading="lazy" onerror="this.style.display='none'">
      </div>
    </div>

    <div class="releases-surface">
      <div class="container">
        <div class="releases-list" id="releases-list"></div>
      </div>
    </div>
  </section>
</main>
<footer class="footer">
  <div class="container small muted">© <span id="year"></span> iStage. Not affiliated with Apple Inc.</div>
  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
  <script>
    const nav = document.querySelector('.nav');
    const toggle = document.querySelector('.nav-toggle');
    const sheet  = document.getElementById('mobile-sheet');
    const body   = document.body;
    if (toggle && sheet) {
      toggle.addEventListener('click', () => {
        const open = nav.classList.toggle('nav--open');
        toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        sheet.setAttribute('aria-hidden', open ? 'false' : 'true');
        body.classList.toggle('no-scroll', open);
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && nav.classList.contains('nav--open')) {
          nav.classList.remove('nav--open');
          toggle.setAttribute('aria-expanded','false');
          sheet.setAttribute('aria-hidden','true');
          body.classList.remove('no-scroll');
        }
      });
    }
    const brand = document.querySelector('.brand');
    const logo  = document.querySelector('.brand-logo');
    const txt   = document.querySelector('.brand-text');
    function update(){ if(brand&&logo&&txt && logo.naturalWidth>0){ brand.classList.add('has-logo'); } }
    if (logo){ if (logo.complete) update(); logo.addEventListener('load', update); logo.addEventListener('error', ()=>brand&&brand.classList.remove('has-logo')); }
  (function(){
    try{
      const mql = window.matchMedia('(prefers-color-scheme: dark)');
      const apply = () => {
        document.documentElement.style.setProperty('--nav-backdrop', mql.matches ? '#000' : '#fff');
      };
      apply();
      if (mql.addEventListener) mql.addEventListener('change', apply);
      else if (mql.addListener) mql.addListener(apply);
    }catch(e){}
  })();
  </script>
  <script>
  /* ---- Releases renderer (GitHub API) ---- */
  (function(){
    const OWNER = 'Modelized';
    const REPO  = 'iStage';
    const list  = document.getElementById('releases-list');
    if (!list) return;

    const esc = (s='') => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    const fmtDate = iso => {
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
      }catch(_){ return iso || ''; }
    };
    const fmtSize = bytes => {
      if (bytes == null) return '';
      const units = ['B','KB','MB','GB'];
      let i = 0, n = bytes;
      while (n >= 1024 && i < units.length-1){ n/=1024; i++; }
      return `${n.toFixed(n < 10 && i>0 ? 1 : 0)} ${units[i]}`;
    };

    // Strip images from markdown
    const stripImages = (md='') =>
      md.replace(/!\[[^\]]*]\([^)]*\)/g, '').replace(/<img[\s\S]*?>/gi, '');

    // Minimal markdown → HTML (headings, lists, links, code, paragraphs)
    const mdToHtml = (md='') => {
      md = stripImages(md);

      // code blocks ``` ```
      md = md.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${esc(code)}</code></pre>`);

      const lines = md.split(/\r?\n/);
      const out = [];
      let inList = false;

      const flushList = () => { if (inList){ out.push('</ul>'); inList = false; } };

      for (let raw of lines){
        const line = raw.trimEnd();

        // headings
        if (/^###\s+/.test(line)){ flushList(); out.push(`<h3>${esc(line.replace(/^###\s+/, ''))}</h3>`); continue; }
        if (/^##\s+/.test(line)){ flushList(); out.push(`<h2>${esc(line.replace(/^##\s+/, ''))}</h2>`); continue; }
        if (/^#\s+/.test(line)){ flushList(); out.push(`<h1>${esc(line.replace(/^#\s+/, ''))}</h1>`); continue; }

        // list items
        if (/^\s*[-*]\s+/.test(line)){
          if (!inList){ out.push('<ul>'); inList = true; }
          out.push(`<li>${esc(line.replace(/^\s*[-*]\s+/, ''))}</li>`);
          continue;
        }

        // blank line
        if (!line.trim()){ flushList(); continue; }

        flushList();

        // inline: links, bold, italics, `code`
        let html = esc(line)
          .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
          .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
          .replace(/\*([^*]+)\*/g, '<em>$1</em>')
          .replace(/`([^`]+)`/g, '<code>$1</code>');

        out.push(`<p>${html}</p>`);
      }
      flushList();
      return out.join('');
    };

    const versionFromTag = (tag = '') => {
      const m = String(tag).match(/\d+/);
      return m ? m[0] : '';
    };

    const tpl = (r, isLatest) => {
      const title = r.name || r.tag_name || 'Untitled';
      const tag   = r.tag_name ? `${r.tag_name}` : '';
      const date  = r.published_at ? fmtDate(r.published_at) : '';
      const asset = (r.assets||[]).find(a => /\.klck$/i.test(a.name)) || (r.assets||[])[0];
      const size  = asset ? fmtSize(asset.size) : '';
      const href  = asset ? asset.browser_download_url : r.html_url;

      const metaText = [date, size].filter(Boolean).join(' • ');
      const latestHtml = isLatest ? '<span class="latest-badge" title="Latest release">Latest</span>' : '';

      const ver  = versionFromTag(tag);
      const icon = ver
        ? `<img class="release-icon" src="../assets/img/iStage-${ver}-icon.png" alt="iStage ${ver} icon" loading="lazy" onerror="this.style.display='none'">`
        : '';

      return `
        <article class="card">
          <header class="release-head">
            ${icon}
            <div class="release-head-text">
              <h3 class="release-title">${esc(title)}</h3>
              <div class="muted small release-meta">${latestHtml}<span>${esc(metaText)}</span></div>
            </div>
          </header>
          <div class="prose" style="margin-top:12px">${mdToHtml(r.body||'')}</div>
          <footer class="release-foot">
            <a class="btn btn-outline" href="${href}" ${asset ? 'download' : ''}>Download</a>
          </footer>
        </article>
      `;
    };

    const showError = (msg) => {
      list.innerHTML = `
        <div class="card" role="alert">
          <strong>Failed to load releases.</strong><br/>
          <span class="small muted">${msg}</span>
        </div>`;
    };

    fetch(`https://api.github.com/repos/${OWNER}/${REPO}/releases`, {
      headers: { 'Accept': 'application/vnd.github+json' }
    })
    .then(r => r.ok ? r.json() : Promise.reject(`${r.status} ${r.statusText}`))
    .then(items => {
      if (!Array.isArray(items) || !items.length){ showError('No releases found.'); return; }
      // Determine latest per major version (based on published_at / created_at)
      const latestByVer = new Map();
      for (const r of items){
        const v = versionFromTag(r.tag_name || '');
        if (!v) continue;
        const prev = latestByVer.get(v);
        const t = new Date(r.published_at || r.created_at || 0).getTime();
        const pt = prev ? new Date(prev.published_at || prev.created_at || 0).getTime() : -Infinity;
        if (!prev || t > pt) latestByVer.set(v, r);
      }
      // Render all releases; show "Latest" badge when this item is the latest for its version
      list.innerHTML = items.map(r => {
        const v = versionFromTag(r.tag_name || '');
        const isLatest = v ? latestByVer.get(v) === r : false;
        return tpl(r, isLatest);
      }).join('');
    })
    .catch(err => showError(String(err)));
  })();
  </script>
</footer>
</body>
</html>