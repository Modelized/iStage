<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>iStage</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">

  <!-- Icons / PWA -->
  <link rel="icon" type="image/svg+xml" href="/iStage/favicon.svg">
  <link rel="icon" sizes="192x192" href="/iStage/android-chrome-192x192.png">
  <link rel="icon" sizes="512x512" href="/iStage/android-chrome-512x512.png">
  <link rel="apple-touch-icon" href="/iStage/apple-touch-icon.png">
  <link rel="mask-icon" href="/iStage/pinned-tab.svg" color="#0f1116">

  <!-- Address bar color -->
  <meta name="theme-color" content="#f5f5f7" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">

  <!-- Open Graph / Twitter thumbnail -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="iStage">
  <meta property="og:title" content="Compare — iStage">
  <meta property="og:description" content="Android. Reimagined.">
  <meta property="og:url" content="https://modelized.github.io/iStage/compare/">
  <meta property="og:image" content="https://modelized.github.io/iStage/assets/img/og.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Compare — iStage">
  <meta name="twitter:description" content="Android. Reimagined.">
  <meta name="twitter:image" content="https://modelized.github.io/iStage/assets/img/og.jpg">

  <style>
    /* ----- Compare page (scoped) ----- */
    :root{
      --surface-light:#f5f5f7;
      --surface-dark:#0f1116;
    }

    .page-compare{ background:#f5f5f7; }
    @media (prefers-color-scheme: dark){
      .page-compare{ background:#000; color:#e8e9ec; }
    }

    .page-compare .subtitle{ color:#5e6572; }
    @media (prefers-color-scheme: dark){
      .page-compare .subtitle{ color:#a7acb7; }
    }

    .page-compare .copy{ gap:6px; }
    .page-compare .title{ margin:0 0 4px; }

    .page-compare .section--first{
      padding-top: calc(env(safe-area-inset-top) + var(--nav-offset-mobile) + 22px);
      margin-top:0;
    }
    @media (min-width:900px){
      .page-compare .section--first{
        padding-top: calc(env(safe-area-inset-top) + var(--nav-offset-desktop) + 24px);
      }
    }

    /* tighter top space above the compare card */
    .compare-surface{ background:transparent; padding:28px 0 24px; }

    .compare-grid{
      display:block;
      min-width:0;
    }

    .compare-card{
      background:#fff;
      color:#111317;
      border:0;
      border-radius: var(--banner-radius);
      overflow:hidden;
    }
    @media (prefers-color-scheme: dark){
      .compare-card{ background:#0f1116; color:#e8e9ec; }
    }
    .compare-stack{
      display:grid;
      gap:16px;
    }

    .compare-head{
      padding:14px 18px 14px;
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap:12px;
      align-items:start;
    }

    /* gradient lives on the whole photo/version area (not inside version label) */
    #compare-card-head{
      position:relative;
    }
    #compare-card-head::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      pointer-events:none;
      background: linear-gradient(
        to bottom,
        rgba(0,0,0,0) 0%,
        rgba(10,11,12,.10) 60%,
        rgba(10,11,12,.18) 100%
      );
    }
    @media (prefers-color-scheme: dark){
      #compare-card-head::before{
        background: linear-gradient(
          to bottom,
          rgba(0,0,0,0) 0%,
          rgba(10,11,12,.35) 60%,
          rgba(10,11,12,.70) 100%
        );
      }
    }
    #compare-card-head > *{
      position:relative;
      z-index:1;
    }

    .compare-picker{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-top:0;
      border-radius:14px;
      background: transparent;
      overflow:hidden;
    }

    .compare-select-wrap{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }

    .compare-select{
      appearance:none;
      -webkit-appearance:none;
      border:0;
      background:transparent;
      color:inherit;
      font: inherit;
      font-weight:700;
      font-size:clamp(18px, 4.8vw, 22px);
      line-height:1.25;
      padding:0 26px 2px 0;
      margin:0;
      width:100%;
      cursor:pointer;
      min-width:0;
      outline:none;
    }

    .compare-select-wrap::after{
      content:"";
      width:24px;
      height:24px;
      flex:0 0 auto;
      position:absolute;
      right:0;
      top:50%;
      transform:translateY(-50%);
      opacity:.85;
      background: currentColor;
      -webkit-mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M6.7 9.3a1 1 0 0 1 1.4 0L12 13.2l3.9-3.9a1 1 0 1 1 1.4 1.4l-4.6 4.6a1 1 0 0 1-1.4 0L6.7 10.7a1 1 0 0 1 0-1.4Z'/%3E%3C/svg%3E");
      mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M6.7 9.3a1 1 0 0 1 1.4 0L12 13.2l3.9-3.9a1 1 0 1 1 1.4 1.4l-4.6 4.6a1 1 0 0 1-1.4 0L6.7 10.7a1 1 0 0 1 0-1.4Z'/%3E%3C/svg%3E");
      -webkit-mask-repeat:no-repeat;
      mask-repeat:no-repeat;
      -webkit-mask-position:center;
      mask-position:center;
      -webkit-mask-size:contain;
      mask-size:contain;
      pointer-events:none;
    }

    .compare-hero{
      display:flex;
      justify-content:center;
      padding-top:2px;
      padding-bottom:6px;
    }

    .compare-hero img{
      width: clamp(150px, 40vw, 260px);
      height:auto;
      filter: drop-shadow(0 10px 36px rgba(0,0,0,.18));
      border-radius: 14px;
    }

    .compare-body{ padding: 18px; }

    .spec-table{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      gap:18px;
    }

    /* Apple-style: one label row, two value columns */
    .spec-item{
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      column-gap:18px;
      row-gap:10px;
      align-items:start;
      padding-bottom:18px;
      border-bottom:1px solid var(--nav-border);
    }
    .spec-item:last-child{ border-bottom:0; padding-bottom:0; }

    .spec-k{
      grid-column:1 / -1;
      font-weight:700;
      opacity:.92;
      letter-spacing:-.01em;
      font-size:clamp(19px, 4.3vw, 22px);
      padding-top:2px;
    }

    .spec-v{
      color:#5e6572;
      min-width:0;
      line-height:1.55;
    }

    .spec-v .line{
      display:block;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .spec-v .line + .line{ margin-top:6px; }

    @media (prefers-color-scheme: dark){
      .spec-v{ color:#a7acb7; }
    }

    @media (max-width:520px){
      .spec-item{
        column-gap:14px;
        row-gap:10px;
      }
    }

    .page-compare .footer{
      background:#f5f5f7;
      color:#5e6572;
    }
    @media (prefers-color-scheme: dark){
      .page-compare .footer{
        background:#000;
        color:#a7acb7;
      }
    }

    .page-compare main{ margin-bottom:0; padding-bottom:0 }
    .page-compare .footer{ margin:0 }
  </style>

  <script>document.documentElement.classList.add('js');</script>
</head>

<body class="page-compare" data-base="..">
  <div class="nav-backdrop" aria-hidden="true"></div>

  <div id="nav-slot"></div>

  <main>
    <section class="section section--first" id="compare">
      <div class="container hero copy">
        <h1 class="title reveal-onload" style="margin-bottom:4px">Compare</h1>
        <p class="subtitle small reveal-onload reveal-delay-1">See what's different across iStage versions.</p>
      </div>

      <div class="compare-surface">
        <div class="container">
          <div class="compare-grid" id="compare-grid">
            <div class="compare-stack" id="compare-stack">
              <article class="compare-card" id="compare-card-head">
                <div class="compare-head">
                  <div>
                    <div class="compare-hero"><img id="img-a" alt="" loading="lazy" onerror="this.style.display='none'"></div>
                    <div class="compare-picker">
                      <div class="compare-select-wrap">
                        <select class="compare-select" id="pick-a" aria-label="Select model A"></select>
                      </div>
                    </div>
                  </div>

                  <div>
                    <div class="compare-hero"><img id="img-b" alt="" loading="lazy" onerror="this.style.display='none'"></div>
                    <div class="compare-picker">
                      <div class="compare-select-wrap">
                        <select class="compare-select" id="pick-b" aria-label="Select model B"></select>
                      </div>
                    </div>
                  </div>
                </div>
              </article>

              <article class="compare-card" id="compare-card-table">
                <div class="compare-body">
                  <ul class="spec-table" id="spec-table"></ul>
                </div>
              </article>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="footer-slot"></div>
  <script src="../assets/js/shell.js" defer></script>

  <script>
(function(){
  const DATA_URL = '../assets/data/compare.json';

  const pickA = document.getElementById('pick-a');
  const pickB = document.getElementById('pick-b');
  const imgA  = document.getElementById('img-a');
  const imgB  = document.getElementById('img-b');
  const specTable = document.getElementById('spec-table');

  if (!pickA || !pickB || !imgA || !imgB || !specTable) return;

  const esc = (s='') => String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));

  const normalizeModel = (m = {}) => {
    const name = (typeof m.name === 'string' && m.name.trim()) ? m.name : 'Untitled';
    const img  = (typeof m.img === 'string') ? m.img : '';

    const toText = (v) => {
      if (v == null) return '';
      if (Array.isArray(v)) return v.map(x => String(x == null ? '' : x)).join('\n');
      if (typeof v === 'object'){
        if (Array.isArray(v.lines)) return v.lines.map(x => String(x == null ? '' : x)).join('\n');
        if (Array.isArray(v.value)) return v.value.map(x => String(x == null ? '' : x)).join('\n');
        if (typeof v.text === 'string') return v.text;
      }
      return String(v);
    };

    let specs = [];

    if (Array.isArray(m.specs)){
      specs = m.specs
        .filter(x => x && typeof x === 'object')
        .map(x => ({
          k: String((x.label ?? x.k ?? x.key ?? '')).trim(),
          v: toText(x.v ?? x.value ?? '')
        }))
        .filter(x => x.k);

    }else if (m.specs && typeof m.specs === 'object' && !Array.isArray(m.specs)){
      specs = Object.entries(m.specs)
        .map(([k, v]) => ({ k: String(k || '').trim(), v: toText(v).trim() }))
        .filter(x => x.k);

    }else if (m.features && typeof m.features === 'object' && !Array.isArray(m.features)){
      specs = Object.entries(m.features)
        .map(([k, v]) => ({ k: String(k || '').trim(), v: toText(v).trim() }))
        .filter(x => x.k);

    }else if (Array.isArray(m.rows) || Array.isArray(m.items)){
      const arr = Array.isArray(m.rows) ? m.rows : m.items;
      specs = arr
        .filter(x => x && typeof x === 'object')
        .map(x => ({
          k: String((x.label ?? x.k ?? x.key ?? x.title ?? '')).trim(),
          v: toText(x.v ?? x.value ?? x.text ?? '').trim()
        }))
        .filter(x => x.k);
    }

    return { name, img, specs };
  };

  const buildSpecKeys = (models, keys) => {
    const out = [];
    const seen = new Set();
    for (const id of keys){
      const m = models[id];
      if (!m || !Array.isArray(m.specs)) continue;
      for (const s of m.specs){
        const k = String(s.k || '').trim();
        if (!k || seen.has(k)) continue;
        seen.add(k);
        out.push(k);
      }
    }
    return out;
  };

  const valueMapFor = (model) => {
    const map = new Map();
    for (const s of (model.specs || [])){
      const k = String(s.k || '').trim();
      if (!k) continue;
      map.set(k, String(s.v ?? ''));
    }
    return map;
  };

  const renderTable = (aId, bId, MODELS, specKeys) => {
    const ma = MODELS[aId];
    const mb = MODELS[bId];

    setImage(imgA, ma);
    setImage(imgB, mb);

    const amap = valueMapFor(ma || {});
    const bmap = valueMapFor(mb || {});

    const toLines = (v) => {
      const raw = String(v == null ? '' : v);
      const lines = raw
        .split(/\r?\n/)
        .map(t => t.trim());
      const cleaned = lines.filter(t => t.length > 0);
      return cleaned.length ? cleaned : ['-'];
    };

    const padLines = (aLines, bLines) => {
      const n = Math.max(aLines.length, bLines.length);
      while (aLines.length < n) aLines.push('');
      while (bLines.length < n) bLines.push('');
      return [aLines, bLines];
    };

    specTable.innerHTML = specKeys.map((k) => {
      let av = toLines(amap.has(k) ? amap.get(k) : '-');
      let bv = toLines(bmap.has(k) ? bmap.get(k) : '-');
      [av, bv] = padLines(av.slice(), bv.slice());

      const lineHtml = (t) => `<span class="line">${t ? esc(t) : '&nbsp;'}</span>`;
      const aHtml = av.map(lineHtml).join('');
      const bHtml = bv.map(lineHtml).join('');

      return `
        <li class="spec-item">
          <div class="spec-k">${esc(k)}</div>
          <div class="spec-v">${aHtml}</div>
          <div class="spec-v">${bHtml}</div>
        </li>
      `;
    }).join('');
  };

  const setImage = (imgEl, m) => {
    const src = (m && typeof m.img === 'string') ? m.img : '';
    imgEl.alt = (m && typeof m.name === 'string') ? m.name : '';

    if (!src){
      imgEl.removeAttribute('src');
      imgEl.style.display = 'none';
      return;
    }

    imgEl.style.display = '';
    imgEl.src = src;
  };

  const fillSelect = (sel, keys, MODELS) => {
    sel.innerHTML = keys.map(k => `<option value="${esc(k)}">${esc(MODELS[k].name)}</option>`).join('');
  };

  fetch(DATA_URL, { cache: 'no-store' })
    .then(r => r.ok ? r.json() : Promise.reject(`${r.status} ${r.statusText}`))
    .then(raw => {
      let src = raw;
      if (raw && typeof raw === 'object' && !Array.isArray(raw) && raw.models){
        src = raw.models;
      }

      const MODELS = {};
      const keys = [];

      if (Array.isArray(src)){
        src.forEach((v, idx) => {
          if (!v || typeof v !== 'object') return;
          const id = String(v.id ?? v.key ?? v.slug ?? v.version ?? idx);
          const nm = normalizeModel(v);
          MODELS[id] = nm;
          keys.push(id);
        });
      }else{
        for (const [k, v] of Object.entries(src || {})){
          if (!v || typeof v !== 'object' || Array.isArray(v)) continue;
          const nm = normalizeModel(v);
          MODELS[String(k)] = nm;
          keys.push(String(k));
        }
      }

      if (!keys.length) throw new Error('No models found in compare data.');

      let specKeys = buildSpecKeys(MODELS, keys);

      const rowsSrc = (
        (raw && typeof raw === 'object' && !Array.isArray(raw) && Array.isArray(raw.rows)) ? raw.rows :
        (raw && typeof raw === 'object' && !Array.isArray(raw) && Array.isArray(raw.specRows)) ? raw.specRows :
        (raw && typeof raw === 'object' && !Array.isArray(raw) && Array.isArray(raw.items)) ? raw.items :
        null
      );

      const rowToKey = (row) => {
        if (!row || typeof row !== 'object') return '';
        return String(row.label ?? row.k ?? row.key ?? row.title ?? row.name ?? '').trim();
      };

      const rowValueFor = (row, modelId, modelIndex) => {
        if (!row || typeof row !== 'object') return '';

        if (row.values && typeof row.values === 'object' && !Array.isArray(row.values)){
          return row.values[modelId];
        }

        if (Array.isArray(row.values)){
          return row.values[modelIndex];
        }

        if (row[modelId] != null){
          return row[modelId];
        }

        if (row.v && typeof row.v === 'object' && !Array.isArray(row.v)){
          return row.v[modelId];
        }

        if (modelIndex === 0 && row.a != null) return row.a;
        if (modelIndex === 1 && row.b != null) return row.b;

        return '';
      };

      if (!specKeys.length && Array.isArray(rowsSrc) && rowsSrc.length){
        keys.forEach((id) => { MODELS[id].specs = []; });

        specKeys = rowsSrc.map(rowToKey).filter(Boolean);

        rowsSrc.forEach((row) => {
          const k = rowToKey(row);
          if (!k) return;

          keys.forEach((id, idx) => {
            const val = rowValueFor(row, id, idx);
            MODELS[id].specs.push({ k, v: (val == null || String(val).trim() === '') ? '-' : String(val) });
          });
        });
      }

      if (!specKeys.length){
        specKeys = ['—'];
        keys.forEach((id) => {
          if (!Array.isArray(MODELS[id].specs) || !MODELS[id].specs.length){
            MODELS[id].specs = [{ k: '—', v: '-' }];
          }
        });
      }

      let a = keys[0];
      let b = keys[1] || keys[0];
      if (a === b && keys.length > 1) b = keys[1];

      fillSelect(pickA, keys, MODELS);
      fillSelect(pickB, keys, MODELS);

      const render = () => {
        pickA.value = a;
        pickB.value = b;
        renderTable(a, b, MODELS, specKeys);
      };

      const setA = (next) => {
        next = String(next);
        if (!MODELS[next]) return;
        if (next === b){
          const prevA = a;
          a = next;
          b = prevA;
        }else{
          a = next;
        }
        render();
      };

      const setB = (next) => {
        next = String(next);
        if (!MODELS[next]) return;
        if (next === a){
          const prevB = b;
          b = next;
          a = prevB;
        }else{
          b = next;
        }
        render();
      };

      pickA.addEventListener('change', () => setA(pickA.value));
      pickB.addEventListener('change', () => setB(pickB.value));

      render();

    })
    .catch(err => {
      pickA.innerHTML = `<option value="error">Failed to load</option>`;
      pickB.innerHTML = `<option value="error">Failed to load</option>`;
      imgA.removeAttribute('src');
      imgB.removeAttribute('src');
      specTable.innerHTML = `<li class="spec-row"><div class="k">Error</div><div class="v"><span class="line">${esc(String(err))}</span></div><div class="v"><span class="line">${esc(String(err))}</span></div></li>`;
    });
})();
</script>
</body>
</html>
